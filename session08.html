<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Session 08 • Long Run Survival Game (Bakery)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#1e3a8a; /* blue-800 */
      --accent:#2563eb;  /* blue-600 */
      --soft:#eff6ff;    /* blue-50 */
      --ok:#059669;      /* green-600 */
      --warn:#d97706;    /* amber-600 */
      --bad:#dc2626;     /* red-600 */
    }
    body{ background: var(--soft); }
    .glass {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(30,58,138,0.08);
    }
    .pill {
      border-radius: 9999px;
      padding: .25rem .6rem;
      font-weight: 600;
      font-size: .75rem;
    }
    .btn {
      background: linear-gradient(90deg, var(--accent), #3b82f6);
      color: white;
      border-radius: .75rem;
      padding: .7rem 1rem;
      font-weight: 700;
      transition: transform .06s ease;
      box-shadow: 0 6px 16px rgba(37,99,235,.25);
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(1px); }
    .meter { height: 10px; background: #e5edff; border-radius: 9999px; overflow: hidden; }
    .meter > div { height: 100%; background: linear-gradient(90deg, #60a5fa, var(--accent)); }
    .tag-ok{ background:#ecfdf5; color: var(--ok); border:1px solid #d1fae5;}
    .tag-warn{ background:#fffbeb; color: var(--warn); border:1px solid #fef3c7;}
    .tag-bad{ background:#fef2f2; color: var(--bad); border:1px solid #fee2e2;}
    .kbd{background:#eef2ff;border:1px solid #c7d2fe;border-bottom-width:2px;border-radius:.5rem;padding:.15rem .4rem;font-weight:700;color:#3730a3}
    .fade-in{animation:fade .35s ease;}
    @keyframes fade{from{opacity:0; transform: translateY(4px);} to{opacity:1; transform:translateY(0);}}
  </style>
</head>

<body class="text-slate-800">
  <!-- Header -->
  <header class="w-full border-b border-blue-100 bg-white">
    <div class="max-w-6xl mx-auto px-4 py-5 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- Optional: ganti src logo bila perlu -->
        <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center text-white font-black">B</div>
        <div>
          <h1 class="text-xl md:text-2xl font-extrabold text-blue-900">Long Run Survival Game — Bakery</h1>
          <p class="text-sm text-slate-500 -mt-1">Session 08 • Perfect Competition • Long-Run Efficiency</p>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-2">
        <span class="pill tag-ok">LO2: Profit Maximization</span>
        <span class="pill tag-warn">Cost (LRAC) & MES</span>
        <span class="pill tag-bad">Entry–Exit Pressure</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Top status -->
    <section class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="glass rounded-2xl p-4 fade-in">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-bold text-blue-900">Tahun</h3>
          <span id="yearTag" class="pill bg-blue-50 text-blue-700 border border-blue-200">Y1/8</span>
        </div>
        <div class="meter"><div id="yearMeter" style="width:12.5%"></div></div>
        <p class="text-sm text-slate-500 mt-2">Selesaikan 8 tahun dengan kondisi <span class="font-semibold">P ≥ AC</span> minimal 5 tahun untuk “Survive (Long Run)”.</p>
      </div>

      <div class="glass rounded-2xl p-4 fade-in">
        <div class="flex items-center justify-between mb-1">
          <h3 class="font-bold text-blue-900">Kas</h3>
          <span id="cashTag" class="pill bg-blue-50 text-blue-700 border border-blue-200">Awal</span>
        </div>
        <div class="text-2xl font-extrabold text-blue-700" id="cashDisplay">Rp 500.000</div>
        <p class="text-xs text-slate-500 mt-1">Jika kas &lt; 0 → kebangkrutan (exit).</p>
      </div>

      <div class="glass rounded-2xl p-4 fade-in">
        <div class="flex items-center justify-between mb-1">
          <h3 class="font-bold text-blue-900">Badge</h3>
          <span id="badgeTag" class="pill tag-warn">Baru Mulai</span>
        </div>
        <p id="badgeMsg" class="text-sm text-slate-600">Tekan <span class="kbd">Enter</span> untuk simulasi cepat.</p>
      </div>
    </section>

    <!-- Controls + News -->
    <section class="grid lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 space-y-4">
        <div class="glass rounded-2xl p-4">
          <h3 class="font-bold text-blue-900 mb-3">Keputusan Tahun Ini</h3>
          <div class="grid md:grid-cols-4 gap-3">
            <div>
              <label class="text-xs font-semibold text-slate-500">Harga Jual (P)</label>
              <input id="price" type="number" value="10000" class="w-full mt-1 rounded-lg border-blue-200 focus:ring-blue-500 focus:border-blue-500" />
              <p class="text-[11px] text-slate-500 mt-1">*Di pasar persaingan sempurna, P ≈ harga pasar (price-taker).</p>
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-500">Output (Q)</label>
              <input id="quantity" type="number" value="100" class="w-full mt-1 rounded-lg border-blue-200 focus:ring-blue-500 focus:border-blue-500" />
              <p class="text-[11px] text-slate-500 mt-1">Hint: Produksi efisien mendekati titik P ≈ MC.</p>
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-500">Investasi Kapasitas</label>
              <input id="capacity" type="number" value="200000" class="w-full mt-1 rounded-lg border-blue-200 focus:ring-blue-500 focus:border-blue-500" />
              <p class="text-[11px] text-slate-500 mt-1">Turunkan LRAC (efek menyicil lewat depresiasi).</p>
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-500">Efisiensi (%)</label>
              <input id="efficiency" type="number" value="10" class="w-full mt-1 rounded-lg border-blue-200 focus:ring-blue-500 focus:border-blue-500" />
              <p class="text-[11px] text-slate-500 mt-1">Lean ops: kurangi biaya variabel.</p>
            </div>
          </div>
          <div class="flex items-center gap-2 mt-4">
            <button id="simulateBtn" class="btn">Jalankan Tahun Ini</button>
            <button id="suggestBtn" class="btn" style="background:linear-gradient(90deg,#0ea5e9,#3b82f6)">Saran Optimal (AI-lite)</button>
            <button id="resetBtn" class="btn" style="background:linear-gradient(90deg,#64748b,#334155)">Reset Game</button>
          </div>
        </div>

        <div class="glass rounded-2xl p-4">
          <h3 class="font-bold text-blue-900 mb-3">News: Entry–Exit & Shock</h3>
          <div id="newsBox" class="text-sm text-slate-700">
            Stabil. Tidak ada kejutan pasar tahun ini.
          </div>
        </div>

        <div class="glass rounded-2xl p-4">
          <h3 class="font-bold text-blue-900 mb-3">Grafik Bar: Harga vs AC (Tahun Ini)</h3>
          <canvas id="barChart" height="120"></canvas>
        </div>
      </div>

      <!-- Right panel: Results + History -->
      <div class="space-y-4">
        <div class="glass rounded-2xl p-4">
          <h3 class="font-bold text-blue-900 mb-3">Ringkasan Tahun Ini</h3>
          <ul id="summary" class="text-sm space-y-1 text-slate-700">
            <li>—</li>
          </ul>
        </div>

        <div class="glass rounded-2xl p-4">
          <h3 class="font-bold text-blue-900 mb-3">Grafik Line: Riwayat P & AC</h3>
          <canvas id="lineChart" height="150"></canvas>
        </div>

        <div class="glass rounded-2xl p-4">
          <h3 class="font-bold text-blue-900 mb-3">Kondisi Long-Run</h3>
          <p id="lrStatus" class="text-sm">
            Target: capai <span class="font-semibold">P ≥ AC</span> minimal <span class="font-semibold">5/8</span> tahun.
          </p>
          <div class="mt-3 meter"><div id="lrMeter" style="width:0%"></div></div>
          <p id="endNote" class="text-sm mt-2 text-slate-500"></p>
        </div>
      </div>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-10 pt-2 text-xs text-slate-500">
    Tips: Gunakan <span class="kbd">Enter</span> untuk jalankan tahun &nbsp;•&nbsp; 
    <span class="kbd">Shift</span> + <span class="kbd">Enter</span> untuk “Saran Optimal”.
  </footer>

<script>
/* ========= State ========= */
let year = 1, maxYear = 8;
let cash = 500000;
let surviveCount = 0; // jumlah tahun P >= AC
let historyP = [], historyAC = [];
let barChart, lineChart;

/* ========= Helpers ========= */
const fmt = n => "Rp " + Math.round(n).toLocaleString("id-ID");

function randomShock(){
  // Market shocks: entry (turun harga), input cost (naik biaya), demand softening (turun P ringan)
  const r = Math.random();
  if(r < 0.25) return {type:"entry", msg:"Masuknya pesaing baru menekan harga pasar.", pFactor:0.95, costFactor:1};
  if(r < 0.45) return {type:"input", msg:"Biaya bahan baku naik (kopi/terigu).", pFactor:1, costFactor:1.08};
  if(r < 0.60) return {type:"demand", msg:"Permintaan melemah sementara, harga pasar sedikit turun.", pFactor:0.97, costFactor:1};
  return {type:"none", msg:"Stabil. Tidak ada kejutan pasar tahun ini.", pFactor:1, costFactor:1};
}

function suggestDecisions(){
  // AI-lite: heuristik agar mendekati kondisi efisien (P ≈ AC dan P ≈ MC)
  // Naikkan investasi jika AC cenderung > P; tambah efisiensi jika Q besar.
  const lastP = historyP.at(-1) ?? 10000;
  const lastAC = historyAC.at(-1) ?? 9800;
  let P = Math.max(7000, Math.round((lastP + lastAC)/2));
  let Q = lastP > lastAC ? 120 : 90;
  let invest = lastAC > lastP ? 300000 : 150000;
  let eff = lastAC > lastP ? 12 : 8;
  return {P,Q,invest,eff};
}

function badge(profit, P, AC){
  if(profit > 0 && P >= AC) return {tag:"Sustain Champion", cls:"tag-ok", msg:"Kamu di jalur long-run: P ≥ AC dan laba positif."};
  if(profit > 0 && P < AC) return {tag:"Short-Run Survivor", cls:"tag-warn", msg:"Masih untung tapi belum efisien (P < AC). Tingkatkan kapasitas/efisiensi."};
  return {tag:"Exit Risk", cls:"tag-bad", msg:"Rugi. Evaluasi harga, Q, dan efisiensi. Perkuat kapasitas untuk turunkan AC."};
}

/* ========= Core Simulation ========= */
function computeYear(decisions){
  // Inputs
  let P = decisions.P;
  let Q = Math.max(1, decisions.Q);
  let invest = Math.max(0, decisions.invest);
  let eff = Math.max(0, Math.min(40, decisions.eff)); // batasi efisiensi 0–40%

  // Shock
  const shock = randomShock();
  P = P * shock.pFactor;

  // Biaya (SR -> LR proxy)
  // FC dasar + depresiasi investasi. Investasi menurunkan AC melalui “kapasitas” (diwakili menekan FC efektif).
  let baseFC = 50000;
  let dep = invest/10; // 10% depresiasi tahunan
  let FC = baseFC + dep * 0.4; // penalti awal investasi (setup & maintenance)
  // Variabel cost
  // Skala: 4000Q + 60Q^2 (sesuai versi awal), disesuaikan shock biaya.
  let VC = (4000*Q + 60*Q*Q) * shock.costFactor;
  // Efisiensi kurangi VAR cost proporsional
  VC = VC * (1 - eff/100);

  // LRAC aproksimasi: (FC+VC)/Q disesuaikan “kapasitas” → invest menurunkan AC dengan efek logis
  let AC = ((FC + VC) / Q) * (1 - Math.min(0.25, Math.log10(1 + invest/100000)/10));

  // Revenue & Profit
  let revenue = P * Q;
  let profit = revenue - (AC * Q);

  // Update kas
  cash += profit;

  // Long-run counter
  if(P >= AC) surviveCount++;

  return {
    P, Q, AC, revenue, profit, shock
  };
}

/* ========= Charts ========= */
function drawBar(P, AC){
  const ctx = document.getElementById('barChart').getContext('2d');
  if(barChart) barChart.destroy();
  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ["Harga (P)", "Average Cost (AC)"],
      datasets: [{
        label: "Rp",
        data: [P, AC],
      }]
    },
    options: {
      plugins:{legend:{display:false}},
      responsive:true,
      scales:{ y:{ beginAtZero:true } }
    }
  });
}

function drawLine(){
  const ctx = document.getElementById('lineChart').getContext('2d');
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array.from({length: historyP.length}, (_,i)=>`Y${i+1}`),
      datasets: [
        {label:"Harga (P)", data: historyP, tension:.25},
        {label:"Average Cost (AC)", data: historyAC, tension:.25}
      ]
    },
    options: {
      responsive:true,
      plugins:{legend:{position:'bottom'}},
      scales:{ y:{ beginAtZero:true } }
    }
  });
}

/* ========= UI Updates ========= */
function updateTop(){
  const pct = (year/maxYear)*100;
  document.getElementById('yearTag').textContent = `Y${year}/${maxYear}`;
  document.getElementById('yearMeter').style.width = pct + "%";
  document.getElementById('cashDisplay').textContent = fmt(cash);
  const cashTag = document.getElementById('cashTag');
  cashTag.textContent = cash >= 0 ? "Likuid" : "Bahaya";
  cashTag.className = "pill " + (cash>=0? "tag-ok":"tag-bad");
}

function updateLR(){
  const pct = (surviveCount/maxYear)*100;
  document.getElementById('lrMeter').style.width = pct + "%";
  const need = 5;
  const note = surviveCount >= need 
    ? `✅ Target tercapai: ${surviveCount}/${maxYear} tahun dengan P ≥ AC.`
    : `Progres: ${surviveCount}/${maxYear} tahun. Butuh ≥ ${need}.`;
  document.getElementById('endNote').textContent = note;
}

function printSummary(res){
  const ul = document.getElementById('summary');
  ul.innerHTML = `
    <li><span class="font-semibold">Shock:</span> ${res.shock.msg}</li>
    <li><span class="font-semibold">Harga (P):</span> ${fmt(res.P)}</li>
    <li><span class="font-semibold">Output (Q):</span> ${Math.round(res.Q).toLocaleString("id-ID")} unit</li>
    <li><span class="font-semibold">Average Cost (AC):</span> ${fmt(res.AC)}</li>
    <li><span class="font-semibold">Revenue:</span> ${fmt(res.revenue)}</li>
    <li><span class="font-semibold">Laba:</span> <span class="${res.profit>=0?'text-emerald-600':'text-red-600'} font-bold">${fmt(res.profit)}</span></li>
  `;
}

function setBadge(res){
  const b = badge(res.profit, res.P, res.AC);
  const tag = document.getElementById('badgeTag');
  tag.textContent = b.tag;
  tag.className = "pill " + b.cls;
  document.getElementById('badgeMsg').textContent = b.msg;
}

/* ========= Game Flow ========= */
function runYear(decisions){
  if(year > maxYear) return;

  const res = computeYear(decisions);

  // Update visuals
  document.getElementById('newsBox').textContent = res.shock.msg;
  drawBar(res.P, res.AC);
  printSummary(res);
  setBadge(res);

  // History for line chart
  historyP.push(res.P);
  historyAC.push(res.AC);
  drawLine();

  updateTop();
  updateLR();

  // Check end conditions
  let endText = "";
  if(cash < 0){
    endText = "❌ Kas negatif. Bisnis exit lebih awal. Perbaiki struktur biaya & kapasitas.";
    year = maxYear + 1; // force end
  }else{
    year++;
    if(year > maxYear){
      if(surviveCount >= 5) endText = "🏆 Survive (Long Run): Kamu efisien di mayoritas tahun. Laba ekonomi → 0 itu normal, yang penting P ≥ AC.";
      else endText = "ℹ️ Belum survive long-run. Capai efisiensi skala (turunkan AC) dan selaraskan Q sehingga P ≈ MC.";
    }
  }
  if(endText) document.getElementById('endNote').textContent = endText;
}

function getUserDecisions(){
  return {
    P: parseFloat(document.getElementById('price').value),
    Q: parseFloat(document.getElementById('quantity').value),
    invest: parseFloat(document.getElementById('capacity').value),
    eff: parseFloat(document.getElementById('efficiency').value)
  };
}

/* ========= Events ========= */
document.getElementById('simulateBtn').addEventListener('click', ()=>{
  runYear(getUserDecisions());
});

document.getElementById('suggestBtn').addEventListener('click', ()=>{
  const s = suggestDecisions();
  document.getElementById('price').value = Math.round(s.P);
  document.getElementById('quantity').value = Math.round(s.Q);
  document.getElementById('capacity').value = Math.round(s.invest);
  document.getElementById('efficiency').value = Math.round(s.eff);
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  year = 1; cash = 500000; surviveCount = 0; historyP = []; historyAC = [];
  document.getElementById('newsBox').textContent = "Stabil. Tidak ada kejutan pasar tahun ini.";
  document.getElementById('summary').innerHTML = "<li>—</li>";
  document.getElementById('badgeTag').textContent = "Baru Mulai";
  document.getElementById('badgeTag').className = "pill tag-warn";
  document.getElementById('badgeMsg').textContent = "Tekan Enter untuk simulasi cepat.";
  document.getElementById('endNote').textContent = "";
  drawLine();
  drawBar(0,0);
  updateTop();
  updateLR();
});

window.addEventListener('keydown', (e)=>{
  if(e.key==="Enter" && !e.shiftKey){ runYear(getUserDecisions()); }
  if(e.key==="Enter" && e.shiftKey){
    const s = suggestDecisions();
    document.getElementById('price').value = Math.round(s.P);
    document.getElementById('quantity').value = Math.round(s.Q);
    document.getElementById('capacity').value = Math.round(s.invest);
    document.getElementById('efficiency').value = Math.round(s.eff);
  }
});

/* ========= Boot ========= */
drawBar(0,0);
drawLine();
updateTop();
updateLR();
</script>
</body>
</html>
